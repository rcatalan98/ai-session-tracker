# Ralph Progress Log
Started: 2026-01-13
---

## Codebase Patterns

- Pattern: Use `gh` CLI for GitHub API calls (already authenticated)
- Pattern: Parse Claude logs from `~/.claude/projects/{project-encoded}/{session-id}.jsonl`
- Pattern: Sessions have `gitBranch` field that links to PRs
- Gotcha: Branch names are in Claude logs, but issue links are in PRs (via "Closes #N")
- Pattern: Cache GitHub data in ~/.config/aist/repos/{owner}-{repo}.json

---

## 2026-01-13 - US-001: GitHub sync command
- Implemented `aist sync` command to fetch merged PRs from GitHub
- Files changed: src/github.rs (new), src/main.rs, src/bottlenecks.rs, src/metrics.rs, src/report.rs
- **Learnings for future iterations:**
  - Use `gh pr list --json` to get structured PR data
  - Parse "Closes #N", "Fixes #N", "Resolves #N" patterns (case insensitive) to find linked issues
  - Store cache with owner, repo, PR list, and sync timestamp
  - RepoCache and PrMapping structs are ready for use by US-002/US-003
  - Added `#[allow(dead_code)]` for load_cache functions that will be used in later stories
---

## 2026-01-13 - US-002: Issue list command
- Implemented `aist issues` command to list GitHub issues with time metrics
- Files changed: src/issues.rs (new), src/main.rs
- **Learnings for future iterations:**
  - Build branchâ†’PR mapping from cache, then match sessions by gitBranch
  - IssueMetrics struct stores: issue_number, title, branch, total_minutes, session_count
  - list_issues() handles all display logic with colored output
  - calculate_issue_metrics() is reusable for US-003/US-004
  - Added tests for edge cases: no branch, no matching PR, PR with no issues
---

## 2026-01-13 - US-003: Issue detail command
- Implemented `aist issue <N>` command to show detailed metrics for a specific issue
- Files changed: src/issues.rs, src/main.rs
- **Learnings for future iterations:**
  - Reuse flamegraph::extract_spans for activity breakdown across sessions
  - IssueSession struct links session reference with calculated duration
  - Use chrono::Local for user-friendly timestamp display
  - Activity breakdown uses HashMap<ActivityType, f64> to aggregate time
  - Colored bar visualization scales percentage/2 to keep it readable
  - format_timestamp() converts UTC to local time for display
---

## 2026-01-13 - US-004: Flamegraph by issue
- Implemented `aist flame --group-by issue` to generate SVG grouped by issue
- Files changed: src/flamegraph.rs, src/main.rs
- **Learnings for future iterations:**
  - Reuse group_sessions_by_issue helper similar to issues.rs pattern
  - IssueGroup struct holds issue_number, title, sessions, total_mins
  - XML escape special characters (&, <, >) in issue titles for SVG
  - Same activity color scheme and proportional bars as generate_svg_by_project
  - Load GitHub cache at start, return clear error if not found
---

## Codebase Patterns (Updated 2026-01-14)

- Pattern: Token usage is in assistant messages under `message.usage`
- Pattern: Fields: input_tokens, cache_creation_input_tokens, cache_read_input_tokens, output_tokens
- Pattern: Cache reads are discounted (usually free), cache creation counts toward input
- Gotcha: Only assistant messages have usage data, not user messages
- Pattern: Claude Opus pricing: $15/M input, $75/M output tokens
- Pattern: Use calculate_cost() from cost.rs for consistent pricing across commands
- Pattern: Add text_content to Message for capturing user prompts
- Pattern: preceding_prompt links bottlenecks to the prompt that triggered them

---

## 2026-01-14 - Prompt Quality & Cost Tracking Feature

### US-001: Extract prompts before bottlenecks
- Added text_content field to Message struct
- Added preceding_prompt field to all bottleneck structs
- Implemented find_preceding_prompt helper to look backwards through messages
- Prompts truncated to 200 chars

### US-002: Show prompts flag for bottlenecks command
- Added --show-prompts flag to `aist bottlenecks`
- Displays prompt in dimmed italic style below each bottleneck

### US-003: Parse token usage from transcripts
- Added token_input and token_output fields to Session struct
- Parse usage data from `message.usage` in assistant messages
- Aggregates input_tokens + cache_creation_input_tokens as billable input

### US-004: Cost command
- Created src/cost.rs with calculate_cost() function
- Added `aist cost` command with --period and --detailed flags
- Shows total tokens, breakdown by input/output, and estimated cost

### US-005: Cost per PR/Issue
- Added cost column to `aist prs` and `aist issues` output
- Added total cost to `aist pr <N>` and `aist issue <N>` detail views
- Reused calculate_cost() for consistent pricing

**Files changed:** src/parser.rs, src/bottlenecks.rs, src/cost.rs (new), src/main.rs, src/prs.rs, src/issues.rs

---
